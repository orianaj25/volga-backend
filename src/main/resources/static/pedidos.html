<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>VOLGA - Nuevo Pedido</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { background:#f4f6f9; }
        .brand { font-weight:700; letter-spacing:1px; font-size:22px; }
        .card { border-radius:1rem; box-shadow:0 10px 20px rgba(0,0,0,.08); }
        .table thead { background:#212529; color:white; }
        .total-box { font-size:22px; font-weight:bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand brand">VOLGA</span>
        <span class="text-white">Nuevo Pedido</span>
        <a href="volga.html" class="btn btn-outline-light btn-sm">Productos</a>
    </div>
</nav>

<div class="container">

    <!-- NUEVO PEDIDO -->
    <div class="card p-3 mb-4">
        <h5>Seleccionar productos</h5>

        <div class="row mb-2">
            <div class="col-md-4">
                <input type="text" id="filtroProductos" class="form-control"
                       placeholder="Buscar producto..."
                       onkeyup="filtrarProductos()">
            </div>
        </div>

        <table class="table table-hover">
            <thead>
            <tr>
                <th></th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
            </tr>
            </thead>
            <tbody id="tabla"></tbody>
        </table>

        <!-- NUEVO: selector de método de pago -->
        <div class="row mt-3 align-items-center">
            <div class="col-md-4">
                <label class="form-label fw-bold">Método de pago</label>
                <select id="metodoPago" class="form-select">
                    <option value="">Seleccione...</option>
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="MP_TRANSFERENCIA">Mercado Pago / Transferencia</option>
                </select>
            </div>

            <div class="col-md-4 total-box">
                Total: $ <span id="total">0</span>
            </div>

            <div class="col-md-4 text-end">
                <button class="btn btn-success" onclick="guardarPedido()">Guardar Pedido</button>
            </div>
        </div>
    </div>

    <!-- DETALLE DE PEDIDOS -->
    <div class="card p-3">
        <h5>Detalle de pedidos</h5>

        <div class="row mb-2">
            <div class="col-md-4">
                <input type="text" id="filtro" class="form-control"
                       placeholder="Buscar por producto, pedido o fecha..."
                       onkeyup="filtrarDetalle()">
            </div>
        </div>

        <table class="table table-striped">
            <thead>
            <tr>
                <th>Pedido</th>
                <th>Fecha</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>Total Pedido</th>
                <th>Método de pago</th> <!-- NUEVO -->
                <th></th>
            </tr>
            </thead>
            <tbody id="tablaDetalle"></tbody>
        </table>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalPedido" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pedido #<span id="modalId"></span></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><b>Fecha:</b> <span id="modalFecha"></span></p>
                <p><b>Total:</b> $<span id="modalTotal"></span></p>
                <p><b>Método de pago:</b> <span id="modalPago"></span></p> <!-- NUEVO -->

                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                    </tr>
                    </thead>
                    <tbody id="modalItems"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const API_PROD = "/api/productos";
    const API_PEDIDOS = "/api/pedidos";

    let productos = [];
    let productosGlobal = [];
    let seleccion = {};
    let detalleGlobal = [];

    function formatearFecha(fechaIso) {
        const f = new Date(fechaIso);
        return f.toLocaleDateString("es-AR",{day:"2-digit",month:"long",year:"numeric"})
            +" "+f.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"});
    }

    function cargarProductos() {
        axios.get(API_PROD).then(r => {
            productos = r.data;
            productosGlobal = r.data;
            renderProductos(productos);
        });
    }

    function renderProductos(lista) {
        const t = document.getElementById("tabla");
        t.innerHTML = "";

        lista.forEach(p => {
            if (!seleccion[p.id]) {
                seleccion[p.id] = { activo:false, cantidad:1 };
            }

            t.innerHTML += `
            <tr>
                <td><input type="checkbox" ${seleccion[p.id].activo?"checked":""}
                    onchange="toggle(${p.id}, this.checked)"></td>
                <td>${p.nombre}</td>
                <td>$${p.precioVenta}</td>
                <td>
                    <input type="number" min="1" value="${seleccion[p.id].cantidad}"
                        class="form-control form-control-sm" style="width:80px"
                        onchange="cambiarCantidad(${p.id}, this.value)"
                        ${seleccion[p.id].activo?"":"disabled"} id="cant-${p.id}">
                </td>
                <td>$ <span id="sub-${p.id}">0</span></td>
            </tr>`;
        });

        recalcular();
    }

    function filtrarProductos() {
        const txt = document.getElementById("filtroProductos").value.toLowerCase();
        renderProductos(productosGlobal.filter(p =>
            p.nombre.toLowerCase().includes(txt)
        ));
    }

    function toggle(id, checked) {
        seleccion[id].activo = checked;
        document.getElementById("cant-" + id).disabled = !checked;
        recalcular();
    }

    function cambiarCantidad(id, cant) {
        seleccion[id].cantidad = parseInt(cant);
        recalcular();
    }

    function recalcular() {
        let total = 0;
        productosGlobal.forEach(p => {
            const sel = seleccion[p.id];
            let sub = 0;
            if (sel && sel.activo) {
                sub = p.precioVenta * sel.cantidad;
                total += sub;
            }
            const el = document.getElementById("sub-" + p.id);
            if (el) el.innerText = sub.toFixed(2);
        });
        document.getElementById("total").innerText = total.toFixed(2);
    }

    // NUEVO: envía método de pago
    function guardarPedido() {
        const items = [];
        for (const id in seleccion) {
            const s = seleccion[id];
            if (s.activo) items.push({ productoId:+id, cantidad:s.cantidad });
        }

        const metodo = document.getElementById("metodoPago").value;

        if (!items.length) return alert("Debe seleccionar al menos un producto");
        if (!metodo) return alert("Debe seleccionar un método de pago");

        axios.post(API_PEDIDOS, {
            items: items,
            metodoPago: metodo
        }).then(() => {
            alert("Pedido guardado");
            cargarDetalle();
            location.reload();
        });
    }

    function cargarDetalle() {
        axios.get(API_PEDIDOS + "/detalle").then(r => {
            detalleGlobal = r.data;
            renderDetalle(detalleGlobal);
        });
    }

    function renderDetalle(lista) {
        const t = document.getElementById("tablaDetalle");
        t.innerHTML = "";
        lista.forEach(d => {
            t.innerHTML += `
            <tr>
                <td>${d.pedidoId}</td>
                <td>${formatearFecha(d.fecha)}</td>
                <td>${d.producto}</td>
                <td>${d.cantidad}</td>
                <td>$${d.subtotal}</td>
                <td>$${d.totalPedido}</td>
                <td>${d.metodoPago}</td> <!-- NUEVO -->
                <td><button class="btn btn-sm btn-primary" onclick="verPedido(${d.pedidoId})">Ver</button></td>
            </tr>`;
        });
    }

    function filtrarDetalle() {
        const txt = document.getElementById("filtro").value.toLowerCase();
        renderDetalle(detalleGlobal.filter(d =>
            d.producto.toLowerCase().includes(txt) ||
            d.pedidoId.toString().includes(txt) ||
            formatearFecha(d.fecha).toLowerCase().includes(txt)
        ));
    }

    function verPedido(id) {
        const pedido = detalleGlobal.filter(d => d.pedidoId === id);
        document.getElementById("modalId").innerText = id;
        document.getElementById("modalFecha").innerText = formatearFecha(pedido[0].fecha);
        document.getElementById("modalTotal").innerText = pedido[0].totalPedido;
        document.getElementById("modalPago").innerText = pedido[0].metodoPago; // NUEVO

        const t = document.getElementById("modalItems");
        t.innerHTML = "";
        pedido.forEach(i => {
            t.innerHTML += `
            <tr>
                <td>${i.producto}</td>
                <td>${i.cantidad}</td>
                <td>$${(i.subtotal / i.cantidad).toFixed(2)}</td>
                <td>$${i.subtotal}</td>
            </tr>`;
        });

        new bootstrap.Modal(document.getElementById("modalPedido")).show();
    }

    cargarProductos();
    cargarDetalle();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
